version: '3.8'

services:
  gemini-os:
    container_name: gemini_os_runtime
    build: .
    
    # [1] ç½‘ç»œç›´é€šï¼šç›´æ¥ä½¿ç”¨å®¿ä¸»æœº IP å’Œç«¯å£
    network_mode: "host"
    
    # [2] ç‰¹æƒæ¨¡å¼ï¼šå…è®¸æŒ‚è½½è®¾å¤‡ï¼Œå…è®¸ä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œå…è®¸çœŸæ­£çš„ Root æ“ä½œ
    privileged: true
    
    # [3] PID ç›´é€šï¼šå…è®¸ AI çœ‹åˆ°å®¿ä¸»æœºçš„æ‰€æœ‰è¿›ç¨‹ (å¦‚ nginx, sshd)
    pid: "host"
    
    # äº¤äº’æ¨¡å¼
    stdin_open: true # -i
    tty: true        # -t
    
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      # ä»£ç†é…ç½® (Hostwinds + Cloudflare WARP ç«¯å£ 40000)
      - http_proxy=socks5h://127.0.0.1:40000
      - https_proxy=socks5h://127.0.0.1:40000
      - HTTP_PROXY=socks5h://127.0.0.1:40000
      - HTTPS_PROXY=socks5h://127.0.0.1:40000
      # å‘Šè¯‰ Python ä¹Ÿæ˜¯ç”¨è¿™ä¸ªä»£ç†
      - ALL_PROXY=socks5h://127.0.0.1:40000
    
    volumes:
      # 1. æŒä¹…åŒ–æ•°æ®ç›˜ (User Data)
      - ./data:/mnt/sysroot
      
      # 2. ä»£ç çƒ­æ›´æ–°æ˜ å°„
      - .:/app
      
      # 3. Docker æ§åˆ¶æƒ (æ§åˆ¶å…„å¼Ÿå®¹å™¨)
      - /var/run/docker.sock:/var/run/docker.sock
      
      # ---------------------------------------------
      # [4] ğŸ’€ ä¸Šå¸è§†è§’ï¼šæŒ‚è½½å®¿ä¸»æœºæ ¹ç›®å½•
      # è­¦å‘Šï¼šè¿™å…è®¸ AI è®¿é—®å¹¶ä¿®æ”¹å®¿ä¸»æœºçš„ä»»ä½•æ–‡ä»¶
      # ---------------------------------------------
      - /:/host_fs

    # å¯åŠ¨å‘½ä»¤ (æŒ‡å‘å…·å¤‡è‡ªæ„ˆèƒ½åŠ›çš„ Bootloader)
    command: ["python", "bootloader.py"]

    # é‡å¯ç­–ç•¥
    restart: unless-stopped